name: FG engagements â†’ Discord (TEST NOW)

on:
  workflow_dispatch: {}

jobs:
  run:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20

      - run: npm i playwright@1.47.2
      - run: npx playwright install --with-deps chromium

      # Run your existing scraper WITHOUT editing it:
      # fakes the clock so the time gate passes for this one run.
      - name: Run scraper (force time without code changes)
        run: |
          node -e "global.Date=class extends Date{constructor(...a){return a.length?super(...a):new Date('2025-01-01T10:35:00+01:00')}}; require('./scrape_engagements.js')"
        env:
          TRAINER_URL: ${{ secrets.TRAINER_URL }}
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}

      - name: Commit updated state
        uses: EndBug/add-and-commit@v9
        with:
          add: 'data/seen.json'
          message: 'chore(test): update seen engagements after test run'
