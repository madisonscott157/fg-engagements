name: FG engagements â†’ Discord (TEST NOW)

on:
  workflow_dispatch: {}   # Manual trigger only

jobs:
  run:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      # Minimal package.json so we can install Playwright quickly (not committed)
      - name: Write package.json (no commit)
        run: |
          cat > package.json <<'JSON'
          {
            "name": "fg-engagements",
            "private": true,
            "type": "commonjs",
            "dependencies": {
              "playwright": "1.47.2"
            }
          }
          JSON

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - run: npm i

      # Install Chromium & OS deps fast
      - name: Setup Playwright
        uses: microsoft/playwright-github-action@v1
        with:
          version: 1.47.2

      # Run your existing scraper WITHOUT editing it:
      # we fake "now" as 10:35 Paris so your time gate passes.
      - name: Run scraper (force time without code changes)
        run: |
          node -e "global.Date=class extends Date{constructor(...a){return a.length?super(...a):new Date('2025-01-01T10:35:00+01:00')}}; require('./scrape_engagements.js')"
        env:
          TRAINER_URL: ${{ secrets.TRAINER_URL }}
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}

      # Persist seen.json so your scheduled job won't repost the same items
      - name: Commit updated state
        uses: EndBug/add-and-commit@v9
        with:
          add: 'data/seen.json'
          message: 'chore(test): update seen engagements after test run'
