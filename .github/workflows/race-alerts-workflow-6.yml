name: Race alerts
on:
  schedule:
    # Run every 10 minutes during French racing hours only
    # Paris is UTC+1 (winter) / UTC+2 (summer)
    # 09:00-20:00 UTC covers ~10:00-21:00 Paris winter, ~11:00-22:00 Paris summer
    - cron: "*/10 9-20 * * *"
  workflow_dispatch:
jobs:
  check-races:
    runs-on: ubuntu-latest
    outputs:
      has_races_today: ${{ steps.check.outputs.has_races_today }}
    steps:
      - uses: actions/checkout@v4
      
      - name: Check if we have races today
        id: check
        run: |
          # Get today's date in DD/MM/YYYY format (Paris timezone)
          TODAY=$(TZ='Europe/Paris' date '+%d/%m/%Y')
          echo "Today in Paris: $TODAY"
          
          # Check if stored_races.json exists and has races for today
          if [ -f "data/stored_races.json" ]; then
            # Count races matching today's date
            RACE_COUNT=$(cat data/stored_races.json | jq --arg today "$TODAY" '[.races[] | select(.date == $today)] | length')
            echo "Races today: $RACE_COUNT"
            
            if [ "$RACE_COUNT" -gt 0 ]; then
              echo "has_races_today=true" >> $GITHUB_OUTPUT
            else
              echo "has_races_today=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "No stored_races.json found"
            echo "has_races_today=false" >> $GITHUB_OUTPUT
          fi

  run-alerts:
    needs: check-races
    if: needs.check-races.outputs.has_races_today == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
      
      - uses: actions/setup-node@v4
        with:
          node-version: 20
      
      # Fix for Microsoft repository 403 errors on GitHub Actions
      - name: Remove problematic Microsoft repositories
        run: |
          sudo rm -f /etc/apt/sources.list.d/microsoft-prod.list
          sudo rm -f /etc/apt/sources.list.d/azure-cli.list
          sudo apt-get update || true
      
      - run: npm i playwright@1.47.2
      
      - run: npx playwright install --with-deps chromium
      
      - run: node scrape_race_alerts.js
        env:
          DISCORD_WEBHOOK_RACE_ALERTS: ${{ secrets.DISCORD_WEBHOOK_RACE_ALERTS }}
      
      - name: Commit race data
        uses: EndBug/add-and-commit@v9
        with:
          add: 'data/*.json'
          message: 'chore: update race alerts data'

  no-races:
    needs: check-races
    if: needs.check-races.outputs.has_races_today == 'false'
    runs-on: ubuntu-latest
    steps:
      - run: echo "No races today - skipping alert checks"
